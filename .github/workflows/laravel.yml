# .github/workflows/deploy.yml

name: Deploy Laravel App to EC2

on:
  push:
    branches:
      - main  # Change if using a different branch

jobs:
  deploy:
    name: Upload & Deploy Laravel
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup SSH Key
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
        chmod 400 ec2_key.pem

    - name: Ensure /var/www exists on EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          sudo mkdir -p /var/www
          sudo chown $USER:$USER /var/www
EOF

    - name: Upload Laravel App to EC2
      run: |
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='vendor' \
          -e "ssh -o StrictHostKeyChecking=no -i ec2_key.pem" \
          ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/laravel-app

    - name: Run Laravel Setup on EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd /var/www/laravel-app

          # Install PHP dependencies
          composer install --no-interaction --prefer-dist --optimize-autoloader

          # Laravel setup
          if [ ! -f ".env" ]; then
            cp .env.example .env
          fi
          php artisan key:generate
          php artisan migrate --force
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

          # Set permissions
          sudo chown -R www-data:www-data /var/www/laravel-app
          sudo chmod -R 775 storage bootstrap/cache
EOF
